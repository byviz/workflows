# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Alert Trigger BÃ¡sico
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DescripciÃ³n: Workflow disparado automÃ¡ticamente por una alerta
# Caso de uso: Respuesta automÃ¡tica a incidentes
# Requisitos: Elastic 9.3+, Alerta configurada en Kibana
# Autor: IvÃ¡n FrÃ­as Molina - Founder Byviz Analytics & Consulting Architect Elastic
# URL: https://byviz.ai/workflows
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: alert-trigger-basico
description: |
  Workflow que se ejecuta cuando una alerta se dispara.
  
  Este workflow:
  1. Recibe datos de la alerta que lo disparÃ³
  2. Procesa la informaciÃ³n del incidente
  3. Registra o ejecuta acciones de respuesta
  
  Para usar este workflow, necesitas:
  - Crear una alerta en Kibana (Stack Management â†’ Alerts)
  - Configurar la acciÃ³n "Run Workflow"
  - Seleccionar este workflow
  
enabled: true
tags: ["basico", "alert", "respuesta-automatica"]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# TRIGGERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Alert: Se ejecuta cuando una alerta de Kibana se dispara
triggers:
  - type: alert
    # El trigger alert recibe automÃ¡ticamente:
    # - alert.id: ID de la alerta
    # - alert.name: Nombre de la alerta
    # - alert.actionGroup: Grupo de acciÃ³n
    # - alert.params: ParÃ¡metros de la alerta
    # - context: Contexto del incidente

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEPS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
steps:
  # Step 1: Procesar informaciÃ³n de la alerta
  - name: analizar_alerta
    type: console
    with:
      message: |
        ğŸš¨ ALERTA RECIBIDA
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Nombre de la alerta: {{alert.name}}
        ID: {{alert.id}}
        Grupo de acciÃ³n: {{alert.actionGroup}}
        Timestamp: {{now | date: "%Y-%m-%d %H:%M:%S"}}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Step 2: Buscar mÃ¡s contexto sobre el incidente
  - name: buscar_contexto_adicional
    type: elasticsearch.search
    with:
      # Buscar en el Ã­ndice relevante
      index: "logs-*"
      
      query:
        bool:
          filter:
            # Ãšltimos 15 minutos (ajustar segÃºn la alerta)
            - range:
                "@timestamp":
                  gte: "now-15m"
                  lte: "now"
      
      # Obtener documentos recientes
      size: 50

  # Step 3: Generar reporte del incidente
  - name: generar_reporte
    type: console
    with:
      message: |
        ğŸ“‹ REPORTE DE INCIDENTE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸš¨ Alerta: {{alert.name}}
        
        ğŸ“Š AnÃ¡lisis:
        - Documentos relacionados: {{steps.buscar_contexto_adicional.output.hits.total.value}}
        - Periodo analizado: Ãšltimos 15 minutos
        - Timestamp: {{now | date: "%Y-%m-%d %H:%M:%S"}}
        
        ğŸ” Mensajes encontrados:
        {% for hit in steps.buscar_contexto_adicional.output.hits.hits %}
        - {{hit._source.message}}
        {% endfor %}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        âœ… PrÃ³ximos pasos:
        1. Revisar logs detallados en Kibana
        2. Validar si requiere escalamiento
        3. Documentar el incidente
        
        ğŸ’¡ Este es un ejemplo bÃ¡sico. En workflows reales puedes:
        - Enviar notificaciones a Slack/Teams
        - Crear tickets en Jira
        - Ejecutar remediaciones automÃ¡ticas
        - Escalar segÃºn severidad

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CÃ“MO CONFIGURAR ESTE WORKFLOW
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# 1. CREAR EL WORKFLOW:
#    - Copia este YAML en Kibana â†’ Stack Management â†’ Workflows
#    - Guarda el workflow
#
# 2. CREAR UNA ALERTA:
#    - Ve a Stack Management â†’ Alerts and Insights â†’ Rules
#    - Crea una nueva regla (ejemplo: "High Error Rate")
#    - Configura las condiciones (ej: >100 errores en 5min)
#
# 3. CONECTAR WORKFLOW A LA ALERTA:
#    - En la alerta, secciÃ³n "Actions"
#    - AÃ±ade una acciÃ³n de tipo "Run Workflow"
#    - Selecciona este workflow: "alert-trigger-basico"
#    - Guarda la alerta
#
# 4. TESTING:
#    - Para probar, dispara la alerta manualmente o espera a que se cumpla la condiciÃ³n
#    - Revisa el historial de ejecuciones del workflow
#
# ğŸ“ EJEMPLOS DE ALERTAS QUE PUEDEN USAR ESTE WORKFLOW:
# - Tasa de errores alta
# - CPU/memoria crÃ­tica
# - Servicios caÃ­dos
# - Transacciones lentas
# - Patrones anÃ³malos detectados por ML
#
# âš ï¸ NOTAS:
# - Ajusta el Ã­ndice y campos segÃºn tu entorno
# - Personaliza las acciones segÃºn tus necesidades
# - En producciÃ³n, aÃ±ade notificaciones reales (Slack, email, etc.)
# - Sort estÃ¡ deshabilitado temporalmente (sintaxis en validaciÃ³n)
# - Acceso a @timestamp en loops tiene limitaciones en esta versiÃ³n
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

