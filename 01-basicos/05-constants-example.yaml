# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Ejemplo de Constantes
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DescripciÃ³n: Uso de constantes para valores reutilizables
# Caso de uso: Centralizar configuraciÃ³n, evitar hardcoding
# Requisitos: Elastic 9.3+
# Autor: IvÃ¡n FrÃ­as Molina - Byviz Analytics
# URL: https://byviz.ai/workflows
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: constants-example
description: |
  Workflow que demuestra el uso de CONSTANTES (consts).
  
  Las constantes permiten:
  - Centralizar valores que se usan mÃºltiples veces
  - Facilitar mantenimiento (cambiar en un solo lugar)
  - Mejorar legibilidad del workflow
  - Evitar hardcoding de valores
  
  Diferencia con inputs:
  - INPUTS: Configurables en cada ejecuciÃ³n
  - CONSTS: Fijos en el workflow, no cambian por ejecuciÃ³n
  
enabled: true
tags: ["basico", "constants", "configuracion"]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONSTANTES
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Valores fijos que se usan en mÃºltiples steps
consts:
  # ConfiguraciÃ³n de Ã­ndices
  logs_index: "logs-app-production-*"
  metrics_index: "metrics-system-*"
  
  # Umbrales
  error_threshold: 100
  warning_threshold: 50
  
  # ConfiguraciÃ³n de tiempo
  time_window: "15m"
  retention_days: 30
  
  # ConfiguraciÃ³n de alertas
  alert_severity: "high"
  alert_channel: "#alerts-production"
  
  # Otros valores reutilizables
  max_results: 20
  es_timeout: "30s"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# TRIGGERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
triggers:
  - type: manual

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STEPS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
steps:
  # Step 1: Mostrar configuraciÃ³n
  - name: mostrar_configuracion
    type: console
    with:
      message: |
        âš™ï¸  CONFIGURACIÃ“N DEL WORKFLOW
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ“‚ ÃNDICES:
        - Logs: {{consts.logs_index}}
        - MÃ©tricas: {{consts.metrics_index}}
        
        âš ï¸  UMBRALES:
        - Errores: {{consts.error_threshold}}
        - Warnings: {{consts.warning_threshold}}
        
        â±ï¸  TIEMPO:
        - Ventana de anÃ¡lisis: {{consts.time_window}}
        - RetenciÃ³n: {{consts.retention_days}} dÃ­as
        
        ğŸš¨ ALERTAS:
        - Severidad: {{consts.alert_severity}}
        - Canal: {{consts.alert_channel}}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Step 2: Buscar errores usando constantes
  - name: buscar_errores
    type: elasticsearch.search
    with:
      # Usar constante para Ã­ndice
      index: "{{consts.logs_index}}"
      
      query:
        bool:
          must:
            - match:
                log.level: "ERROR"
          
          filter:
            - range:
                "@timestamp":
                  # Usar constante para ventana de tiempo
                  gte: "now-{{consts.time_window}}"
                  lte: "now"
      
      # Usar constante para lÃ­mite de resultados
      size: "{{consts.max_results}}"
      
      # Usar constante para timeout
      timeout: "{{consts.es_timeout}}"
      
      sort:
        - "@timestamp":
            order: desc

  # Step 3: Evaluar si supera umbral
  - name: evaluar_umbral
    type: if
    with:
      # Comparar con constante error_threshold
      condition: "{{steps.buscar_errores.output.hits.total.value > consts.error_threshold}}"
      
      then:
        # Si supera el umbral
        - type: console
          with:
            message: |
              ğŸš¨ ALERTA CRÃTICA
              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              
              Se superÃ³ el umbral de errores!
              
              Errores detectados: {{steps.buscar_errores.output.hits.total.value}}
              Umbral configurado: {{consts.error_threshold}}
              Periodo: Ãšltimos {{consts.time_window}}
              Ãndice: {{consts.logs_index}}
              
              Severidad: {{consts.alert_severity | upcase}}
              Notificar en: {{consts.alert_channel}}
              
              âš ï¸  AcciÃ³n requerida inmediata
              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      else:
        # Si NO supera el umbral
        - type: console
          with:
            message: |
              âœ… SISTEMA NORMAL
              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              
              Errores detectados: {{steps.buscar_errores.output.hits.total.value}}
              Umbral configurado: {{consts.error_threshold}}
              
              Sistema operando dentro de parÃ¡metros normales.
              â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Step 4: Buscar warnings usando las mismas constantes
  - name: buscar_warnings
    type: elasticsearch.search
    with:
      # Reutilizar constantes
      index: "{{consts.logs_index}}"
      
      query:
        bool:
          must:
            - match:
                log.level: "WARN"
          
          filter:
            - range:
                "@timestamp":
                  gte: "now-{{consts.time_window}}"
                  lte: "now"
      
      size: 0  # Solo queremos el conteo

  # Step 5: Reporte final
  - name: reporte_final
    type: console
    with:
      message: |
        ğŸ“Š REPORTE FINAL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Periodo analizado: Ãšltimos {{consts.time_window}}
        Ãndice: {{consts.logs_index}}
        
        ERRORES: {{steps.buscar_errores.output.hits.total.value}} / {{consts.error_threshold}}
        WARNINGS: {{steps.buscar_warnings.output.hits.total.value}} / {{consts.warning_threshold}}
        
        {% if steps.buscar_errores.output.hits.total.value > consts.error_threshold %}
        ğŸš¨ Estado: CRÃTICO
        {% elsif steps.buscar_warnings.output.hits.total.value > consts.warning_threshold %}
        âš ï¸  Estado: ADVERTENCIA
        {% else %}
        âœ… Estado: NORMAL
        {% endif %}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ’¡ Las constantes facilitan:
        - Cambiar configuraciÃ³n en un solo lugar
        - Mantener consistency en todo el workflow
        - Reutilizar valores mÃºltiples veces
        - Hacer el cÃ³digo mÃ¡s legible

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VENTAJAS DE USAR CONSTANTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. MANTENIBILIDAD:
#    - Cambiar un valor en un solo lugar
#    - Si el Ã­ndice cambia de nombre, actualizar una vez
#    - Si cambian umbrales, modificar en la secciÃ³n consts
#
# 2. LEGIBILIDAD:
#    - {{consts.error_threshold}} es mÃ¡s claro que 100
#    - El nombre describe el propÃ³sito del valor
#    - MÃ¡s fÃ¡cil de entender para otros desarrolladores
#
# 3. REUTILIZACIÃ“N:
#    - Usar el mismo valor en mÃºltiples steps
#    - Evitar inconsistencias por duplicaciÃ³n
#    - Un cambio se aplica en todas partes
#
# 4. CONFIGURACIÃ“N CENTRALIZADA:
#    - Todos los valores configurables en un solo lugar
#    - FÃ¡cil de revisar la configuraciÃ³n completa
#    - DocumentaciÃ³n implÃ­cita del workflow
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CUÃNDO USAR CONSTS VS INPUTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Usa CONSTS cuando:
# âœ… El valor es fijo para el workflow
# âœ… Se usa en mÃºltiples places
# âœ… Representa configuraciÃ³n del entorno
# âœ… No necesitas cambiarlo en cada ejecuciÃ³n
#
# Ejemplos: Ã­ndices, umbrales, URLs de APIs, timeouts
#
# Usa INPUTS cuando:
# âœ… El valor puede cambiar en cada ejecuciÃ³n
# âœ… El usuario debe poder configurarlo
# âœ… Necesitas flexibilidad en runtime
# âœ… Es un parÃ¡metro de bÃºsqueda o filtro variable
#
# Ejemplos: fecha especÃ­fica, ID de usuario, query custom
#
# ğŸ’¡ Puedes combinar ambos:
# - consts para configuraciÃ³n base
# - inputs para parÃ¡metros variables
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

