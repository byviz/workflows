# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Alertas a PagerDuty
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: pagerduty-alert
description: Crea incidentes en PagerDuty automÃ¡ticamente
enabled: true
tags: ["pagerduty", "oncall", "incident"]

consts:
  pagerduty_integration_key: "YOUR_INTEGRATION_KEY"

triggers:
  - type: alert

steps:
  - name: analizar_severidad
    type: elasticsearch.search
    with:
      index: "logs-*"
      query:
        bool:
          must:
            - match:
                log.level: "ERROR"
          filter:
            - range:
                "@timestamp":
                  gte: "now-5m"
      size: 0
  
  - name: trigger_pagerduty
    type: console
    with:
      message: |
        ðŸ“Ÿ PAGERDUTY ALERT (simulado)
        
        Severidad: {% if steps.analizar_severidad.output.hits.total.value > 500 %}critical{% else %}error{% endif %}
        Errores: {{steps.analizar_severidad.output.hits.total.value}}
        
        API Call:
        POST https://events.pagerduty.com/v2/enqueue
        {
          "routing_key": "{{consts.pagerduty_integration_key}}",
          "event_action": "trigger",
          "payload": {
            "summary": "High error rate detected",
            "severity": "critical",
            "source": "elastic-workflow",
            "custom_details": {
              "error_count": {{steps.analizar_severidad.output.hits.total.value}}
            }
          }
        }

