# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Notificaciones a Slack
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: slack-notification
description: |
  EnvÃ­a notificaciones enriquecidas a Slack cuando hay incidentes.
  Usa formateo rich con bloques y colores.
enabled: true
tags: ["alerting", "slack", "notificaciones"]

consts:
  slack_channel: "#alerts-production"
  critical_threshold: 500

triggers:
  - type: alert

steps:
  # 1. Analizar incidente
  - name: analizar_incidente
    type: elasticsearch.search
    with:
      index: "logs-*"
      query:
        bool:
          must:
            - match:
                log.level: "ERROR"
          filter:
            - range:
                "@timestamp":
                  gte: "now-10m"
      size: 5
      aggregations:
        servicios:
          terms:
            field: "service.name"
            size: 5
  
  # 2. Determinar severidad y emoji
  - name: preparar_mensaje
    type: console
    with:
      message: |
        Severidad: {% if steps.analizar_incidente.output.hits.total.value > consts.critical_threshold %}ğŸš¨ CRÃTICA{% else %}âš ï¸ MEDIA{% endif %}
        Total errores: {{steps.analizar_incidente.output.hits.total.value}}
  
  # 3. Enviar notificaciÃ³n a Slack (simulado)
  # En producciÃ³n, configurar Slack connector en Kibana
  - name: notificar_slack
    type: console
    with:
      message: |
        ğŸ“¨ SLACK NOTIFICATION (simulado)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Canal: {{consts.slack_channel}}
        
        {% if steps.analizar_incidente.output.hits.total.value > consts.critical_threshold %}
        ğŸš¨ *ALERTA CRÃTICA*
        {% else %}
        âš ï¸  *Alerta Media*
        {% endif %}
        
        *High Error Rate Detected*
        
        ğŸ“Š *Resumen:*
        â€¢ Errores detectados: {{steps.analizar_incidente.output.hits.total.value}}
        â€¢ Periodo: Ãšltimos 10 minutos
        â€¢ Timestamp: {{now | date: "%Y-%m-%d %H:%M:%S"}}
        
        ğŸ¢ *Servicios afectados:*
        {% for bucket in steps.analizar_incidente.output.aggregations.servicios.buckets limit:5 %}
        â€¢ {{bucket.key}}: {{bucket.doc_count}} errores
        {% endfor %}
        
        ğŸ” *Primeros errores:*
        {% for hit in steps.analizar_incidente.output.hits.hits limit:3 %}
        {{loop.index}}. `{{hit._source.service.name | default: "N/A"}}` - {{hit._source.message | truncate: 80}}
        {% endfor %}
        
        ğŸ”— *Actions:*
        â€¢ <https://kibana.example.com|View in Kibana>
        â€¢ <https://jira.example.com|Create Ticket>
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # 4. En producciÃ³n, usar el connector de Slack:
  # - name: enviar_slack_real
  #   type: slack.message
  #   with:
  #     channel: "{{consts.slack_channel}}"
  #     text: |
  #       {% if steps.analizar_incidente.output.hits.total.value > consts.critical_threshold %}ğŸš¨{% else %}âš ï¸{% endif %} High Error Rate Detected
  #       
  #       Errores: {{steps.analizar_incidente.output.hits.total.value}}
  #       Periodo: Ãšltimos 10 minutos
  #       
  #       Servicios afectados:
  #       {% for bucket in steps.analizar_incidente.output.aggregations.servicios.buckets limit:3 %}
  #       â€¢ {{bucket.key}}: {{bucket.doc_count}}
  #       {% endfor %}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURAR SLACK CONNECTOR:
# 1. Kibana â†’ Stack Management â†’ Connectors
# 2. Create connector â†’ Slack
# 3. Configurar webhook URL
# 4. Usar type: slack.message en el workflow
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

