# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: CreaciÃ³n AutomÃ¡tica de Tickets
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: auto-ticket-creation
description: |
  Crea tickets automÃ¡ticamente cuando se detecta un incidente.
  Incluye contexto completo y asigna segÃºn reglas.
enabled: true
tags: ["alerting", "tickets", "jira"]

consts:
  jira_project: "OPS"
  default_assignee: "ops-team"

triggers:
  - type: alert

steps:
  # 1. Recopilar informaciÃ³n del incidente
  - name: recopilar_info
    type: elasticsearch.search
    with:
      index: "logs-*"
      query:
        bool:
          must:
            - match:
                log.level: "ERROR"
          filter:
            - range:
                "@timestamp":
                  gte: "now-15m"
      size: 20
      aggregations:
        servicios_afectados:
          terms:
            field: "service.name"
            size: 10
  
  # 2. Determinar prioridad
  - name: calcular_prioridad
    type: if
    with:
      condition: "{{steps.recopilar_info.output.hits.total.value > 500}}"
      then:
        - type: console
          with:
            message: "Prioridad: CRITICAL"
      else:
        - type: console
          with:
            message: "Prioridad: MEDIUM"
  
  # 3. Preparar payload del ticket (simulado con console)
  # En producciÃ³n, usar http.request para API de Jira
  - name: crear_ticket
    type: console
    with:
      message: |
        ğŸ« TICKET CREADO (simulado)
        
        Project: {{consts.jira_project}}
        Type: Incident
        Priority: {% if steps.recopilar_info.output.hits.total.value > 500 %}Critical{% else %}Medium{% endif %}
        Assignee: {{consts.default_assignee}}
        
        Title: High Error Rate Detected - {{now | date: "%Y-%m-%d %H:%M"}}
        
        Description:
        Se detectaron {{steps.recopilar_info.output.hits.total.value}} errores en los Ãºltimos 15 minutos.
        
        Servicios afectados:
        {% for bucket in steps.recopilar_info.output.aggregations.servicios_afectados.buckets %}
        - {{bucket.key}}: {{bucket.doc_count}} errores
        {% endfor %}
        
        Timeline: {{now | date: "%Y-%m-%d %H:%M:%S"}}
        Link to Kibana: [Generar link a Discover]
        
        Ãšltimos errores:
        {% for hit in steps.recopilar_info.output.hits.hits %}
        - [{{hit._source.@timestamp}}] {{hit._source.message | truncate: 100}}
        {% endfor %}
  
  # 4. En producciÃ³n, descomentar para crear ticket real:
  # - name: crear_ticket_jira
  #   type: http.request
  #   with:
  #     url: "https://your-jira.atlassian.net/rest/api/3/issue"
  #     method: POST
  #     headers:
  #       Authorization: "Bearer {{secrets.jira_token}}"
  #       Content-Type: "application/json"
  #     body:
  #       fields:
  #         project:
  #           key: "{{consts.jira_project}}"
  #         summary: "High Error Rate - {{now | date: '%Y-%m-%d %H:%M'}}"
  #         description: "{{steps.recopilar_info.output.hits.total.value}} errors detected"
  #         issuetype:
  #           name: "Incident"
  #         priority:
  #           name: "{% if steps.recopilar_info.output.hits.total.value > 500 %}Critical{% else %}Medium{% endif %}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PARA INTEGRACIÃ“N REAL CON JIRA:
# 1. Crear API token en Jira
# 2. Guardar en Kibana Keystore: bin/elasticsearch-keystore add workflows.jira_token
# 3. Descomentar el step http.request
# 4. Ajustar URL y campos segÃºn tu instancia de Jira
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

