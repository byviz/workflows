# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Pipeline Multi-Step Complejo
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: multi-step-pipeline
description: Pipeline completo de anÃ¡lisis, decisiÃ³n y acciÃ³n
enabled: true
tags: ["avanzado", "pipeline", "production"]

consts:
  index_pattern: "logs-*"
  error_threshold: 100
  critical_threshold: 500

triggers:
  - type: scheduled
    with:
      schedule: "*/10 * * * *"  # Cada 10 minutos

steps:
  # STAGE 1: Data Collection
  - name: stage1_collect_errors
    type: elasticsearch.search
    with:
      index: "{{consts.index_pattern}}"
      query:
        bool:
          must:
            - match:
                log.level: "ERROR"
          filter:
            - range:
                "@timestamp":
                  gte: "now-10m"
      size: 100
      aggregations:
        por_servicio:
          terms:
            field: "service.name"
            size: 10
        por_tipo:
          terms:
            field: "error.type"
            size: 10
  
  # STAGE 2: Analysis & Classification
  - name: stage2_classify_severity
    type: if
    with:
      condition: "{{steps.stage1_collect_errors.output.hits.total.value >= consts.critical_threshold}}"
      then:
        - type: console
          with:
            message: "CRITICAL: {{steps.stage1_collect_errors.output.hits.total.value}} errors"
      else:
        - type: if
          with:
            condition: "{{steps.stage1_collect_errors.output.hits.total.value >= consts.error_threshold}}"
            then:
              - type: console
                with:
                  message: "WARNING: {{steps.stage1_collect_errors.output.hits.total.value}} errors"
            else:
              - type: console
                with:
                  message: "INFO: {{steps.stage1_collect_errors.output.hits.total.value}} errors"
  
  # STAGE 3: Enrichment
  - name: stage3_get_context
    type: elasticsearch.search
    with:
      index: "metrics-*"
      query:
        range:
          "@timestamp":
            gte: "now-10m"
      size: 20
      _source:
        - "system.cpu.total.pct"
        - "system.memory.used.pct"
        - "host.name"
  
  # STAGE 4: Decision & Action
  - name: stage4_decide_action
    type: if
    with:
      condition: "{{steps.stage1_collect_errors.output.hits.total.value >= consts.critical_threshold}}"
      then:
        # Actions para CRITICAL
        - type: console
          with:
            message: |
              ğŸš¨ CRITICAL ACTIONS:
              âœ… Create PagerDuty incident
              âœ… Send Slack notification
              âœ… Create Jira ticket
              âœ… Alert on-call engineer
      else:
        # Actions para WARNING/INFO
        - type: console
          with:
            message: |
              â„¹ï¸ STANDARD ACTIONS:
              âœ… Log to console
              âœ… Update dashboard
  
  # STAGE 5: Reporting & Cleanup
  - name: stage5_final_report
    type: console
    with:
      message: |
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ğŸ“‹ PIPELINE EXECUTION REPORT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Timestamp: {{now | date: "%Y-%m-%d %H:%M:%S"}}
        
        STAGE 1 - Data Collection:
        âœ… Errors collected: {{steps.stage1_collect_errors.output.hits.total.value}}
        âœ… Services analyzed: {{steps.stage1_collect_errors.output.aggregations.por_servicio.buckets.size}}
        
        STAGE 2 - Classification:
        âœ… Severity: {% if steps.stage1_collect_errors.output.hits.total.value >= consts.critical_threshold %}CRITICAL{% elsif steps.stage1_collect_errors.output.hits.total.value >= consts.error_threshold %}WARNING{% else %}INFO{% endif %}
        
        STAGE 3 - Enrichment:
        âœ… Metrics collected: {{steps.stage3_get_context.output.hits.total.value}}
        
        STAGE 4 - Actions:
        âœ… Actions executed based on severity
        
        STAGE 5 - Completion:
        âœ… Pipeline completed successfully
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ’¡ Este pipeline demuestra:
        - MÃºltiples stages secuenciales
        - Decisiones condicionales en cada stage
        - Enrichment de datos
        - Acciones basadas en anÃ¡lisis
        - Reporting completo

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PATRÃ“N: MULTI-STAGE PIPELINE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# Este patrÃ³n es Ãºtil para:
# âœ“ Procesos complejos que requieren mÃºltiples pasos
# âœ“ Decisiones que dependen de anÃ¡lisis previos
# âœ“ Workflows que necesitan enriquecimiento de datos
# âœ“ Casos donde cada stage puede fallar independientemente
# 
# Best Practices:
# - Nombrar stages claramente (stage1_, stage2_, etc.)
# - Cada stage tiene responsabilidad Ãºnica
# - Manejar errores en cada stage
# - Loguear progreso entre stages
# - Permitir reintento de stages fallidos
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

