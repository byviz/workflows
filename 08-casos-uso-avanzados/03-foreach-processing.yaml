# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Procesamiento con ForEach
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: foreach-processing
description: Procesa cada elemento de un array con foreach
enabled: true
tags: ["avanzado", "foreach", "iteration"]

triggers:
  - type: manual

steps:
  # 1. Obtener lista de servicios con errores
  - name: obtener_servicios_con_errores
    type: elasticsearch.search
    with:
      index: "logs-*"
      query:
        bool:
          must:
            - match:
                log.level: "ERROR"
          filter:
            - range:
                "@timestamp":
                  gte: "now-1h"
      size: 0
      aggregations:
        servicios:
          terms:
            field: "service.name"
            size: 20
  
  # 2. Procesar cada servicio individualmente
  - name: procesar_cada_servicio
    type: foreach
    with:
      items: "{{steps.obtener_servicios_con_errores.output.aggregations.servicios.buckets}}"
      do:
        # Para cada servicio, analizar en detalle
        - type: console
          with:
            message: |
              ğŸ” Analizando servicio: {{item.key}}
              Errores: {{item.doc_count}}
              
              {% if item.doc_count > 100 %}
              âš ï¸ HIGH - Requiere investigaciÃ³n inmediata
              {% elsif item.doc_count > 50 %}
              âš¡ MEDIUM - Monitorear de cerca
              {% else %}
              âœ… LOW - Dentro de parÃ¡metros normales
              {% endif %}
  
  # 3. Resumen final
  - name: resumen_procesamiento
    type: console
    with:
      message: |
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ğŸ“Š RESUMEN DE PROCESAMIENTO FOREACH
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Servicios procesados: {{steps.obtener_servicios_con_errores.output.aggregations.servicios.buckets.size}}
        
        Listado:
        {% for bucket in steps.obtener_servicios_con_errores.output.aggregations.servicios.buckets %}
        {{loop.index}}. {{bucket.key}}: {{bucket.doc_count}} errores
        {% endfor %}
        
        ğŸ’¡ Foreach permite procesar cada elemento con lÃ³gica especÃ­fica

