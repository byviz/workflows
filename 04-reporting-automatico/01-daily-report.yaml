# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Reporte Diario AutomÃ¡tico
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: daily-report
description: Genera reporte diario con mÃ©tricas clave del sistema
enabled: true
tags: ["reporting", "daily", "automatico"]

consts:
  report_time_range: "24h"

triggers:
  - type: scheduled
    with:
      schedule: "0 8 * * *"  # Diario a las 8am

steps:
  # Conteo de logs por severidad
  - name: logs_por_severidad
    type: elasticsearch.search
    with:
      index: "logs-*"
      query:
        range:
          "@timestamp":
            gte: "now-{{consts.report_time_range}}"
      size: 0
      aggregations:
        por_nivel:
          terms:
            field: "log.level"
            size: 10
  
  # Servicios mÃ¡s activos
  - name: top_servicios
    type: elasticsearch.search
    with:
      index: "logs-*"
      query:
        range:
          "@timestamp":
            gte: "now-{{consts.report_time_range}}"
      size: 0
      aggregations:
        servicios:
          terms:
            field: "service.name"
            size: 10
  
  # Errores del dÃ­a
  - name: contar_errores
    type: elasticsearch.search
    with:
      index: "logs-*"
      query:
        bool:
          must:
            - match:
                log.level: "ERROR"
          filter:
            - range:
                "@timestamp":
                  gte: "now-{{consts.report_time_range}}"
      size: 0
  
  # Generar reporte
  - name: generar_reporte
    type: console
    with:
      message: |
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ğŸ“Š REPORTE DIARIO - {{now | date: "%Y-%m-%d"}}
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ“… Periodo: Ãšltimas {{consts.report_time_range}}
        ğŸ• Generado: {{now | date: "%Y-%m-%d %H:%M:%S"}}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ğŸ“ˆ RESUMEN GENERAL
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
        Total de logs: {{steps.logs_por_severidad.output.hits.total.value}}
        Total de errores: {{steps.contar_errores.output.hits.total.value}}
        
        DistribuciÃ³n por severidad:
        {% for bucket in steps.logs_por_severidad.output.aggregations.por_nivel.buckets %}
        - {{bucket.key | upcase}}: {{bucket.doc_count}}
        {% endfor %}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ğŸ† TOP 5 SERVICIOS MÃS ACTIVOS
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {% for bucket in steps.top_servicios.output.aggregations.servicios.buckets limit:5 %}
        {{loop.index}}. {{bucket.key}}: {{bucket.doc_count}} logs
        {% endfor %}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        âœ… SALUD DEL SISTEMA
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {% assign error_rate = steps.contar_errores.output.hits.total.value | times: 100 | divided_by: steps.logs_por_severidad.output.hits.total.value %}
        Tasa de errores: {{error_rate | round: 2}}%
        
        Estado: {% if error_rate < 1 %}âœ… EXCELENTE{% elsif error_rate < 5 %}âš ï¸ ACEPTABLE{% else %}ğŸš¨ REVISAR{% endif %}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ’¡ Este reporte se enviarÃ­a por email en producciÃ³n
        
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Para enviar por email, aÃ±adir:
# - name: enviar_email
#   type: email.send
#   with:
#     to: "equipo@empresa.com"
#     subject: "Reporte Diario - {{now | date: '%Y-%m-%d'}}"
#     body: "{{steps.generar_reporte.output}}"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

