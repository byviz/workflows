# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Agregaciones Avanzadas
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DescripciÃ³n: Agregaciones anidadas, buckets y pipeline aggregations
# Caso de uso: AnÃ¡lisis complejos, drill-down, mÃ©tricas derivadas
# Requisitos: Elastic 9.3+
# Autor: IvÃ¡n FrÃ­as Molina - Byviz Analytics
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: aggregations-advanced
description: |
  Agregaciones avanzadas: nested buckets, sub-aggregations, pipeline.
  
enabled: true
tags: ["agregaciones", "avanzado", "nested", "pipeline"]

consts:
  index: "logs-*"
  time_range: "24h"

triggers:
  - type: manual

steps:
  # Agregaciones anidadas (nested buckets)
  - name: analisis_multinivel
    type: elasticsearch.search
    with:
      index: "{{consts.index}}"
      
      query:
        range:
          "@timestamp":
            gte: "now-{{consts.time_range}}"
      
      size: 0
      
      aggregations:
        # Nivel 1: Por servicio
        por_servicio:
          terms:
            field: "service.name"
            size: 10
          
          aggregations:
            # Nivel 2: Por nivel de log dentro de cada servicio
            por_nivel:
              terms:
                field: "log.level"
                size: 5
              
              aggregations:
                # Nivel 3: Timeline dentro de cada nivel
                timeline:
                  date_histogram:
                    field: "@timestamp"
                    fixed_interval: "1h"
  
  # Pipeline aggregations
  - name: pipeline_aggregations
    type: elasticsearch.search
    with:
      index: "metrics-*"
      
      query:
        range:
          "@timestamp":
            gte: "now-{{consts.time_range}}"
      
      size: 0
      
      aggregations:
        # Timeline de CPU
        cpu_timeline:
          date_histogram:
            field: "@timestamp"
            fixed_interval: "1h"
          
          aggregations:
            cpu_avg:
              avg:
                field: "system.cpu.total.pct"
            
            # Derivative: cambio entre buckets
            cpu_derivative:
              derivative:
                buckets_path: "cpu_avg"
            
            # Moving average
            cpu_moving_avg:
              moving_avg:
                buckets_path: "cpu_avg"
                window: 3
  
  # Percentiles
  - name: analisis_percentiles
    type: elasticsearch.search
    with:
      index: "traces-apm-*"
      
      query:
        range:
          "@timestamp":
            gte: "now-{{consts.time_range}}"
      
      size: 0
      
      aggregations:
        response_time_percentiles:
          percentiles:
            field: "transaction.duration.us"
            percents: [50, 75, 90, 95, 99]
  
  # Reporte
  - name: reporte
    type: console
    with:
      message: |
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ğŸ“Š AGREGACIONES AVANZADAS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ” ANÃLISIS MULTINIVEL (Servicio â†’ Nivel â†’ Timeline):
        {% for servicio in steps.analisis_multinivel.output.aggregations.por_servicio.buckets %}
        
        ğŸ“¦ Servicio: {{servicio.key}} ({{servicio.doc_count}} logs)
        {% for nivel in servicio.por_nivel.buckets %}
          â””â”€ {{nivel.key}}: {{nivel.doc_count}}
        {% endfor %}
        {% endfor %}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
        ğŸ“ˆ PERCENTILES DE RESPONSE TIME:
        P50: {{steps.analisis_percentiles.output.aggregations.response_time_percentiles.values.50.0 | divided_by: 1000 | round: 2}}ms
        P75: {{steps.analisis_percentiles.output.aggregations.response_time_percentiles.values.75.0 | divided_by: 1000 | round: 2}}ms
        P90: {{steps.analisis_percentiles.output.aggregations.response_time_percentiles.values.90.0 | divided_by: 1000 | round: 2}}ms
        P95: {{steps.analisis_percentiles.output.aggregations.response_time_percentiles.values.95.0 | divided_by: 1000 | round: 2}}ms
        P99: {{steps.analisis_percentiles.output.aggregations.response_time_percentiles.values.99.0 | divided_by: 1000 | round: 2}}ms
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

