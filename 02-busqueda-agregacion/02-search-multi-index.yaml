# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: BÃºsqueda Multi-Ãndice
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DescripciÃ³n: Buscar datos en mÃºltiples Ã­ndices simultÃ¡neamente
# Caso de uso: AnÃ¡lisis correlacionado, bÃºsqueda cross-Ã­ndice
# Requisitos: Elastic 9.3+
# Autor: IvÃ¡n FrÃ­as Molina - Byviz Analytics
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: search-multi-index
description: |
  BÃºsquedas que abarcan mÃºltiples Ã­ndices simultÃ¡neamente.
  
  Casos de uso:
  - Correlacionar logs, mÃ©tricas y APM
  - BÃºsqueda en logs de mÃºltiples aplicaciones
  - AnÃ¡lisis cross-entorno (dev, staging, prod)
  - AgregaciÃ³n de datos de mÃºltiples fuentes
  
enabled: true
tags: ["busqueda", "multi-index", "correlacion"]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
consts:
  time_range: "1h"
  max_results: 50

inputs:
  - name: correlation_id
    type: string
    description: "ID para correlacionar entre Ã­ndices"
    required: false
    default: ""
  
  - name: service_name
    type: string
    description: "Nombre del servicio a analizar"
    required: false
    default: ""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
triggers:
  - type: manual

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
steps:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. BÃšSQUEDA EN LOGS Y MÃ‰TRICAS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: buscar_logs_y_metricas
    type: elasticsearch.search
    with:
      # MÃºltiples Ã­ndices separados por coma
      index: "logs-*,metrics-*"
      
      query:
        bool:
          filter:
            - range:
                "@timestamp":
                  gte: "now-{{consts.time_range}}"
                  lte: "now"
      
      size: "{{consts.max_results}}"
      
      sort:
        - "@timestamp:desc"
      
      # Incluir el Ã­ndice en los resultados
      _source:
        includes:
          - "*"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. BÃšSQUEDA POR SERVICIO EN MÃšLTIPLES ÃNDICES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: buscar_por_servicio
    type: elasticsearch.search
    with:
      index: "logs-*,traces-apm-*,metrics-*"
      
      query:
        bool:
          must:
            - match:
                service.name: "{{inputs.service_name}}"
          
          filter:
            - range:
                "@timestamp":
                  gte: "now-{{consts.time_range}}"
      
      size: 100
      
      # Agregar por Ã­ndice para ver distribuciÃ³n
      aggregations:
        por_indice:
          terms:
            field: "_index"
            size: 20
        
        por_tipo:
          terms:
            field: "data_stream.type"
            size: 10

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. CORRELACIÃ“N POR TRACE ID
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: correlacion_por_trace
    type: elasticsearch.search
    with:
      # Buscar en logs, APM traces y spans
      index: "logs-*,traces-apm-*"
      
      query:
        bool:
          should:
            # Buscar trace.id en diferentes campos segÃºn el Ã­ndice
            - term:
                trace.id: "{{inputs.correlation_id}}"
            - term:
                transaction.id: "{{inputs.correlation_id}}"
            - term:
                span.id: "{{inputs.correlation_id}}"
          
          minimum_should_match: 1
          
          filter:
            - range:
                "@timestamp":
                  gte: "now-{{consts.time_range}}"
      
      size: 200
      
      sort:
        - "@timestamp:asc"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. BÃšSQUEDA EN ENTORNOS (dev, staging, prod)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: buscar_cross_entorno
    type: elasticsearch.search
    with:
      # Wildcard que abarca mÃºltiples entornos
      index: "logs-*-dev-*,logs-*-staging-*,logs-*-prod-*"
      
      query:
        bool:
          must:
            - match:
                log.level: "ERROR"
          
          filter:
            - range:
                "@timestamp":
                  gte: "now-24h"
      
      size: 0  # Solo queremos agregaciones
      
      aggregations:
        errores_por_entorno:
          terms:
            field: "environment"
            size: 10
        
        errores_timeline:
          date_histogram:
            field: "@timestamp"
            fixed_interval: "1h"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5. BÃšSQUEDA CON EXCLUSIONES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: buscar_con_exclusiones
    type: elasticsearch.search
    with:
      # Todos los logs EXCEPTO system logs
      index: "logs-*,-logs-system-*"
      
      query:
        bool:
          must:
            - exists:
                field: "error.message"
          
          must_not:
            # Excluir logs de health checks
            - match:
                message: "health check"
          
          filter:
            - range:
                "@timestamp":
                  gte: "now-{{consts.time_range}}"
      
      size: 20

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 6. ANÃLISIS AGREGADO MULTI-ÃNDICE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: analisis_agregado
    type: elasticsearch.search
    with:
      index: "logs-*,metrics-*,traces-apm-*"
      
      query:
        bool:
          filter:
            - range:
                "@timestamp":
                  gte: "now-24h"
      
      size: 0
      
      aggregations:
        # DistribuciÃ³n por data stream
        por_data_stream:
          terms:
            field: "data_stream.dataset"
            size: 20
        
        # Top servicios
        top_servicios:
          terms:
            field: "service.name"
            size: 10
        
        # Timeline de eventos
        timeline:
          date_histogram:
            field: "@timestamp"
            fixed_interval: "1h"
            
            # Sub-agregaciÃ³n: contar por tipo
            aggregations:
              por_tipo:
                terms:
                  field: "data_stream.type"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # REPORTE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: reporte_multi_index
    type: console
    with:
      message: |
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ğŸ” ANÃLISIS MULTI-ÃNDICE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Periodo: Ãšltimas {{consts.time_range}}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        1ï¸âƒ£  LOGS Y MÃ‰TRICAS COMBINADOS
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        Total documentos: {{steps.buscar_logs_y_metricas.output.hits.total.value}}
        Tiempo: {{steps.buscar_logs_y_metricas.output.took}}ms
        
        {% if inputs.service_name != "" %}
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        2ï¸âƒ£  BÃšSQUEDA POR SERVICIO: {{inputs.service_name}}
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        Total: {{steps.buscar_por_servicio.output.hits.total.value}}
        
        DistribuciÃ³n por Ã­ndice:
        {% for bucket in steps.buscar_por_servicio.output.aggregations.por_indice.buckets limit:5 %}
        - {{bucket.key}}: {{bucket.doc_count}} documentos
        {% endfor %}
        {% endif %}
        
        {% if inputs.correlation_id != "" %}
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        3ï¸âƒ£  CORRELACIÃ“N POR TRACE ID: {{inputs.correlation_id}}
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        Documentos correlacionados: {{steps.correlacion_por_trace.output.hits.total.value}}
        
        Timeline:
        {% for hit in steps.correlacion_por_trace.output.hits.hits limit:10 %}
        [{{hit._source.@timestamp}}] {{hit._index}}
          â†’ {{hit._source.message | default: hit._source.transaction.name | default: "N/A"}}
        {% endfor %}
        {% endif %}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        4ï¸âƒ£  ERRORES CROSS-ENTORNO
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        Total errores (24h): {{steps.buscar_cross_entorno.output.hits.total.value}}
        
        Por entorno:
        {% for bucket in steps.buscar_cross_entorno.output.aggregations.errores_por_entorno.buckets %}
        - {{bucket.key | upcase}}: {{bucket.doc_count}} errores
        {% endfor %}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        5ï¸âƒ£  ANÃLISIS AGREGADO COMPLETO
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
        Top Data Streams:
        {% for bucket in steps.analisis_agregado.output.aggregations.por_data_stream.buckets limit:5 %}
        {{loop.index}}. {{bucket.key}}: {{bucket.doc_count}}
        {% endfor %}
        
        Top Servicios:
        {% for bucket in steps.analisis_agregado.output.aggregations.top_servicios.buckets limit:5 %}
        {{loop.index}}. {{bucket.key}}: {{bucket.doc_count}}
        {% endfor %}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ’¡ VENTAJAS DE BÃšSQUEDA MULTI-ÃNDICE:
        
        âœ… Correlacionar datos de mÃºltiples fuentes
        âœ… Vista unificada de logs, mÃ©tricas y traces
        âœ… AnÃ¡lisis cross-entorno en una sola query
        âœ… Mejor para investigaciÃ³n de incidentes
        âœ… Reduce necesidad de mÃºltiples bÃºsquedas
        
        âš ï¸  CONSIDERACIONES:
        
        â†’ Puede ser mÃ¡s lento que bÃºsqueda en un solo Ã­ndice
        â†’ Usar filtros para limitar el scope
        â†’ Considerar impacto en cluster con wildcards amplios
        â†’ Usar size: 0 si solo necesitas agregaciones

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PATRONES DE ÃNDICES MULTI-INDEX
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# SINTAXIS:
# - "index1,index2,index3"           â†’ Ãndices especÃ­ficos
# - "logs-*,metrics-*"               â†’ Wildcards mÃºltiples
# - "logs-*,-logs-debug-*"           â†’ Con exclusiones (-)
# - "logs-{app1,app2,app3}-*"        â†’ ExpansiÃ³n de llaves
#
# EJEMPLOS COMUNES:
# 
# Observabilidad completa:
#   "logs-*,metrics-*,traces-apm-*"
#
# MÃºltiples aplicaciones:
#   "logs-app1-*,logs-app2-*,logs-app3-*"
#
# Cross-entorno:
#   "logs-*-dev-*,logs-*-staging-*,logs-*-prod-*"
#
# Con exclusiones:
#   "logs-*,-logs-system-*,-logs-audit-*"
#
# Data streams:
#   "logs-*,logs-*-*"
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

