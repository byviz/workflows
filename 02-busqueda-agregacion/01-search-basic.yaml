# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: BÃºsqueda BÃ¡sica con Filtros
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DescripciÃ³n: Queries bÃ¡sicas con filtros y ordenamiento
# Caso de uso: BÃºsqueda de logs, eventos, documentos especÃ­ficos
# Requisitos: Elastic 9.3+
# Autor: IvÃ¡n FrÃ­as Molina - Byviz Analytics
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: search-basic
description: |
  Ejemplos de bÃºsquedas bÃ¡sicas en Elasticsearch usando workflows.
  
  Cubre:
  - Match queries
  - Bool queries
  - Range filters
  - Sorting
  - Field selection
  
enabled: true
tags: ["busqueda", "queries", "filtros"]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
consts:
  default_index: "logs-*"
  time_range: "24h"
  max_results: 50

inputs:
  - name: search_term
    type: string
    description: "TÃ©rmino a buscar"
    default: "error"
    required: false
  
  - name: log_level
    type: string
    description: "Nivel de log (ERROR, WARN, INFO)"
    default: "ERROR"
    required: false

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
triggers:
  - type: manual

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
steps:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. BÃšSQUEDA SIMPLE - Match query
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: busqueda_simple
    type: elasticsearch.search
    with:
      index: "{{consts.default_index}}"
      
      # Match query: busca el tÃ©rmino en el campo message
      query:
        match:
          message: "{{inputs.search_term}}"
      
      size: 10
      
      # Ordenar por relevancia (_score) y fecha
      sort:
        - "_score:desc"
        - "@timestamp:desc"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. BÃšSQUEDA CON FILTROS - Bool query
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: busqueda_con_filtros
    type: elasticsearch.search
    with:
      index: "{{consts.default_index}}"
      
      query:
        bool:
          # MUST: Condiciones que deben cumplirse (afectan score)
          must:
            - match:
                message: "{{inputs.search_term}}"
          
          # FILTER: Condiciones que deben cumplirse (no afectan score)
          filter:
            # Filtrar por nivel de log
            - term:
                log.level: "{{inputs.log_level}}"
            
            # Filtrar por rango de tiempo
            - range:
                "@timestamp":
                  gte: "now-{{consts.time_range}}"
                  lte: "now"
      
      size: "{{consts.max_results}}"
      
      sort:
        - "@timestamp:desc"
      
      # Seleccionar solo campos especÃ­ficos
      _source:
        - "@timestamp"
        - "message"
        - "log.level"
        - "service.name"
        - "host.name"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. BÃšSQUEDA CON SHOULD - Match opcional
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: busqueda_con_should
    type: elasticsearch.search
    with:
      index: "{{consts.default_index}}"
      
      query:
        bool:
          # CondiciÃ³n mÃ­nima requerida
          must:
            - range:
                "@timestamp":
                  gte: "now-{{consts.time_range}}"
          
          # SHOULD: Condiciones opcionales (aumentan score si se cumplen)
          should:
            - match:
                message: "error"
            - match:
                message: "exception"
            - match:
                message: "failed"
          
          # MÃ­nimo de condiciones should que deben cumplirse
          minimum_should_match: 1
      
      size: 20
      
      sort:
        - "_score:desc"
        - "@timestamp:desc"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. BÃšSQUEDA CON WILDCARDS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: busqueda_wildcard
    type: elasticsearch.search
    with:
      index: "{{consts.default_index}}"
      
      query:
        bool:
          must:
            # Wildcard: busca patrones con * y ?
            - wildcard:
                message: "*{{inputs.search_term}}*"
          
          filter:
            - range:
                "@timestamp":
                  gte: "now-1h"
      
      size: 15

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5. BÃšSQUEDA MULTI-CAMPO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: busqueda_multi_campo
    type: elasticsearch.search
    with:
      index: "{{consts.default_index}}"
      
      query:
        multi_match:
          # Buscar en mÃºltiples campos
          query: "{{inputs.search_term}}"
          fields:
            - "message^2"      # ^2 = boost (mÃ¡s importancia)
            - "error.message"
            - "log.logger"
          
          # Tipo de match
          type: "best_fields"
      
      size: 10

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # REPORTE DE RESULTADOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  - name: reporte_busqueda
    type: console
    with:
      message: |
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ğŸ“Š REPORTE DE BÃšSQUEDAS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ParÃ¡metros:
        - Ãndice: {{consts.default_index}}
        - TÃ©rmino: "{{inputs.search_term}}"
        - Nivel: {{inputs.log_level}}
        - Rango: Ãšltimas {{consts.time_range}}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
        1ï¸âƒ£  BÃšSQUEDA SIMPLE (Match):
        Total: {{steps.busqueda_simple.output.hits.total.value}}
        Tiempo: {{steps.busqueda_simple.output.took}}ms
        
        2ï¸âƒ£  BÃšSQUEDA CON FILTROS (Bool):
        Total: {{steps.busqueda_con_filtros.output.hits.total.value}}
        Tiempo: {{steps.busqueda_con_filtros.output.took}}ms
        
        Primeros resultados:
        {% for hit in steps.busqueda_con_filtros.output.hits.hits %}
        [{{loop.index}}] {{hit._source.@timestamp}}
            ğŸ“ {{hit._source.message | truncate: 100}}
            ğŸ·ï¸  {{hit._source.log.level}} | {{hit._source.service.name | default: "N/A"}}
        {% endfor %}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
        3ï¸âƒ£  BÃšSQUEDA CON SHOULD (Match opcional):
        Total: {{steps.busqueda_con_should.output.hits.total.value}}
        Tiempo: {{steps.busqueda_con_should.output.took}}ms
        
        4ï¸âƒ£  BÃšSQUEDA WILDCARD:
        Total: {{steps.busqueda_wildcard.output.hits.total.value}}
        Tiempo: {{steps.busqueda_wildcard.output.took}}ms
        
        5ï¸âƒ£  BÃšSQUEDA MULTI-CAMPO:
        Total: {{steps.busqueda_multi_campo.output.hits.total.value}}
        Tiempo: {{steps.busqueda_multi_campo.output.took}}ms
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ’¡ Tips:
        - Bool queries con filter son mÃ¡s rÃ¡pidas
        - Use must para condiciones que afectan relevancia
        - Use filter para condiciones exactas
        - Should permite matches opcionales
        - Wildcards son Ãºtiles pero pueden ser lentos en datasets grandes

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NOTAS SOBRE TIPOS DE QUERIES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# MATCH:
# - Full-text search
# - Analiza el texto
# - Bueno para bÃºsqueda de usuarios
#
# TERM:
# - Match exacto
# - No analiza el texto
# - Perfecto para keywords, IDs, enums
#
# RANGE:
# - Rangos numÃ©ricos o de fechas
# - gte, gt, lte, lt
#
# BOOL:
# - Combina mÃºltiples queries
# - must: AND (afecta score)
# - filter: AND (no afecta score, mÃ¡s rÃ¡pido)
# - should: OR (opcional)
# - must_not: NOT
#
# WILDCARD:
# - Patrones con * (muchos) y ? (uno)
# - Puede ser lento en Ã­ndices grandes
#
# MULTI_MATCH:
# - Busca en mÃºltiples campos
# - Soporta boost (^N)
# - Varios tipos: best_fields, most_fields, cross_fields
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

