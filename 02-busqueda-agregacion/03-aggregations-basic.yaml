# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Agregaciones BÃ¡sicas
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DescripciÃ³n: Terms, metrics y agregaciones fundamentales
# Caso de uso: EstadÃ­sticas, conteos, anÃ¡lisis descriptivo
# Requisitos: Elastic 9.3+
# Autor: IvÃ¡n FrÃ­as Molina - Byviz Analytics
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: aggregations-basic
description: |
  Agregaciones bÃ¡sicas de Elasticsearch: terms, metrics, stats.
  
  AprenderÃ¡s:
  - Terms aggregation (conteos por categorÃ­a)
  - Metrics: sum, avg, max, min
  - Stats aggregation (estadÃ­sticas completas)
  - Cardinality (valores Ãºnicos)
  
enabled: true
tags: ["agregaciones", "metrics", "estadisticas"]

consts:
  index: "logs-*"
  time_range: "24h"

triggers:
  - type: manual

steps:
  # Terms aggregation: Top N por campo
  - name: top_errores_por_tipo
    type: elasticsearch.search
    with:
      index: "{{consts.index}}"
      
      query:
        bool:
          must:
            - match:
                log.level: "ERROR"
          filter:
            - range:
                "@timestamp":
                  gte: "now-{{consts.time_range}}"
      
      size: 0  # Solo agregaciones
      
      aggregations:
        # Top 10 tipos de error
        top_errores:
          terms:
            field: "error.type"
            size: 10
            order:
              _count: desc
        
        # Top servicios con errores
        top_servicios:
          terms:
            field: "service.name"
            size: 10
  
  # Metrics aggregations
  - name: metricas_performance
    type: elasticsearch.search
    with:
      index: "metrics-*"
      
      query:
        range:
          "@timestamp":
            gte: "now-{{consts.time_range}}"
      
      size: 0
      
      aggregations:
        # Promedio
        cpu_avg:
          avg:
            field: "system.cpu.total.pct"
        
        # MÃ¡ximo
        cpu_max:
          max:
            field: "system.cpu.total.pct"
        
        # MÃ­nimo
        memory_min:
          min:
            field: "system.memory.used.pct"
        
        # Suma total
        total_requests:
          sum:
            field: "http.request.count"
        
        # EstadÃ­sticas completas
        response_time_stats:
          stats:
            field: "http.response.time"
  
  # Cardinality: valores Ãºnicos
  - name: usuarios_unicos
    type: elasticsearch.search
    with:
      index: "{{consts.index}}"
      
      query:
        range:
          "@timestamp":
            gte: "now-{{consts.time_range}}"
      
      size: 0
      
      aggregations:
        # Contar usuarios Ãºnicos
        unique_users:
          cardinality:
            field: "user.id"
        
        # Hosts Ãºnicos
        unique_hosts:
          cardinality:
            field: "host.name"
        
        # IPs Ãºnicas
        unique_ips:
          cardinality:
            field: "client.ip"
  
  # Reporte
  - name: reporte_agregaciones
    type: console
    with:
      message: |
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ğŸ“Š REPORTE DE AGREGACIONES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ”´ TOP ERRORES (Ãºltimas {{consts.time_range}}):
        {% for bucket in steps.top_errores_por_tipo.output.aggregations.top_errores.buckets limit:5 %}
        {{loop.index}}. {{bucket.key}}: {{bucket.doc_count}} ocurrencias
        {% endfor %}
        
        ğŸ¢ TOP SERVICIOS CON ERRORES:
        {% for bucket in steps.top_errores_por_tipo.output.aggregations.top_servicios.buckets limit:5 %}
        {{loop.index}}. {{bucket.key}}: {{bucket.doc_count}} errores
        {% endfor %}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
        âš¡ MÃ‰TRICAS DE PERFORMANCE:
        CPU Promedio: {{steps.metricas_performance.output.aggregations.cpu_avg.value | round: 2}}%
        CPU MÃ¡ximo: {{steps.metricas_performance.output.aggregations.cpu_max.value | round: 2}}%
        Memory MÃ­nimo: {{steps.metricas_performance.output.aggregations.memory_min.value | round: 2}}%
        
        Response Time:
        - Min: {{steps.metricas_performance.output.aggregations.response_time_stats.min}}ms
        - Max: {{steps.metricas_performance.output.aggregations.response_time_stats.max}}ms
        - Avg: {{steps.metricas_performance.output.aggregations.response_time_stats.avg | round: 2}}ms
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
        ğŸ‘¥ CARDINALIDAD:
        Usuarios Ãºnicos: {{steps.usuarios_unicos.output.aggregations.unique_users.value}}
        Hosts Ãºnicos: {{steps.usuarios_unicos.output.aggregations.unique_hosts.value}}
        IPs Ãºnicas: {{steps.usuarios_unicos.output.aggregations.unique_ips.value}}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

