# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Eliminar Ãndices Antiguos
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: delete-old-indices
description: Elimina Ã­ndices mÃ¡s antiguos que X dÃ­as para liberar espacio
enabled: false  # âš ï¸ Disabled por seguridad - habilitar con precauciÃ³n
tags: ["mantenimiento", "limpieza", "indices"]

consts:
  retention_days: 30
  index_pattern: "logs-*"

triggers:
  - type: scheduled
    with:
      schedule: "0 2 * * 0"  # Domingos a las 2am

steps:
  # 1. Listar Ã­ndices antiguos
  - name: identificar_indices_antiguos
    type: console
    with:
      message: |
        ğŸ” Buscando Ã­ndices mÃ¡s antiguos que {{consts.retention_days}} dÃ­as
        PatrÃ³n: {{consts.index_pattern}}
        
        âš ï¸  NOTA: En este ejemplo, la eliminaciÃ³n estÃ¡ simulada.
        
        Para implementar eliminaciÃ³n real:
        1. Usar ILM (Index Lifecycle Management) es la mejor prÃ¡ctica
        2. O usar API de Elasticsearch vÃ­a http.request
        
        Ejemplo con ILM:
        - Kibana â†’ Stack Management â†’ Index Lifecycle Policies
        - Crear policy con hot/warm/cold/delete phases
        - Aplicar a index templates
  
  # 2. Simular anÃ¡lisis
  - name: analizar_impacto
    type: elasticsearch.search
    with:
      index: "{{consts.index_pattern}}"
      query:
        range:
          "@timestamp":
            lt: "now-{{consts.retention_days}}d"
      size: 0
  
  # 3. Reporte
  - name: reporte_limpieza
    type: console
    with:
      message: |
        ğŸ“‹ REPORTE DE LIMPIEZA
        
        Documentos mÃ¡s antiguos que {{consts.retention_days}} dÃ­as: {{steps.analizar_impacto.output.hits.total.value}}
        
        âš ï¸  RECOMENDACIÃ“N: Usar ILM en lugar de workflows para gestiÃ³n de Ã­ndices
        
        ILM ofrece:
        âœ… GestiÃ³n automÃ¡tica del ciclo de vida
        âœ… Hot/Warm/Cold tiers
        âœ… Rollover automÃ¡tico
        âœ… EliminaciÃ³n segura con polÃ­ticas
        âœ… Snapshots antes de delete

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âš ï¸ IMPORTANTE - ELIMINACIÃ“N DE ÃNDICES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# NO uses workflows para eliminar Ã­ndices sin precauciones:
# 
# 1. MEJOR PRÃCTICA: Usa ILM (Index Lifecycle Management)
# 2. Si usas workflows, implementa:
#    - ConfirmaciÃ³n manual antes de delete
#    - Snapshot automÃ¡tico previo
#    - Lista blanca/negra de Ã­ndices
#    - Logs de auditorÃ­a
#    - Dry-run mode
# 
# 3. Testea en entorno no productivo primero
# 4. Ten plan de recuperaciÃ³n (backups)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

