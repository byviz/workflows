# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WORKFLOW: Root Cause Analysis con IA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: root-cause-analysis-ai
description: |
  Usa agentes de IA para analizar incidentes y determinar causa raÃ­z.
  
  El agente analiza:
  - Logs de error
  - MÃ©tricas de sistema
  - Traces APM
  - Contexto histÃ³rico
  
  Y genera:
  - Causa raÃ­z probable
  - Impacto estimado
  - Recomendaciones de soluciÃ³n
  - Pasos de remediaciÃ³n
  
enabled: true
tags: ["ia", "rca", "analisis", "agente"]

consts:
  ai_agent_id: "root-cause-analyzer"  # ID del agente configurado en Agent Builder

triggers:
  - type: alert

steps:
  # 1. Recopilar contexto del incidente
  - name: recopilar_logs_error
    type: elasticsearch.search
    with:
      index: "logs-*"
      query:
        bool:
          must:
            - match:
                log.level: "ERROR"
          filter:
            - range:
                "@timestamp":
                  gte: "now-15m"
      size: 20
      sort:
        - "@timestamp:desc"
  
  # 2. Obtener mÃ©tricas de sistema
  - name: obtener_metricas
    type: elasticsearch.search
    with:
      index: "metrics-system-*"
      query:
        range:
          "@timestamp":
            gte: "now-15m"
      size: 50
      _source:
        - "system.cpu.total.pct"
        - "system.memory.used.pct"
        - "system.load.1"
        - "host.name"
  
  # 3. Buscar traces relacionados
  - name: obtener_traces
    type: elasticsearch.search
    with:
      index: "traces-apm-*"
      query:
        bool:
          filter:
            - range:
                "@timestamp":
                  gte: "now-15m"
            - exists:
                field: "error.message"
      size: 10
  
  # 4. Preparar contexto para el agente IA
  - name: preparar_contexto
    type: console
    with:
      message: |
        ğŸ“‹ CONTEXTO PARA ANÃLISIS IA
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ERRORES DETECTADOS: {{steps.recopilar_logs_error.output.hits.total.value}}
        
        Ãšltimos errores:
        {% for hit in steps.recopilar_logs_error.output.hits.hits %}
        - [{{hit._source.@timestamp}}] {{hit._source.service.name}}: {{hit._source.message}}
        {% endfor %}
        
        MÃ‰TRICAS DE SISTEMA:
        {% for hit in steps.obtener_metricas.output.hits.hits %}
        - Host: {{hit._source.host.name}}
          CPU: {{hit._source.system.cpu.total.pct | times: 100 | round: 2}}%
          Memory: {{hit._source.system.memory.used.pct | times: 100 | round: 2}}%
        {% endfor %}
        
        TRACES CON ERROR: {{steps.obtener_traces.output.hits.total.value}}
  
  # 5. Llamar al agente IA (simulado)
  # En producciÃ³n, usar el step agent.query cuando estÃ© disponible
  - name: consultar_agente_ia
    type: console
    with:
      message: |
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ğŸ¤– ANÃLISIS DE IA - ROOT CAUSE ANALYSIS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        âš ï¸ NOTA: Este es un ejemplo simulado.
        
        Para implementaciÃ³n real con Agent Builder:
        
        1. Configurar agente en Elastic:
           - Kibana â†’ Search â†’ Agent Builder
           - Crear agente "root-cause-analyzer"
           - Conectar con LLM (OpenAI, Bedrock, etc.)
           - Definir knowledge base y tools
        
        2. Usar en workflow:
           - name: consultar_agente
             type: agent.query
             with:
               agent_id: "{{consts.ai_agent_id}}"
               query: "Analiza estos {{steps.recopilar_logs_error.output.hits.total.value}} errores..."
               context:
                 logs: "{{steps.recopilar_logs_error.output}}"
                 metrics: "{{steps.obtener_metricas.output}}"
                 traces: "{{steps.obtener_traces.output}}"
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ“Š ANÃLISIS SIMULADO (lo que el agente generarÃ­a):
        
        ğŸ” CAUSA RAÃZ IDENTIFICADA:
        Basado en el anÃ¡lisis de logs, mÃ©tricas y traces:
        
        - Alto uso de memoria (>90%) en host-prod-01
        - Connection pool exhausted en servicio-api
        - Spike de errores coincide con deploy reciente
        
        ğŸ’¡ CAUSA PROBABLE:
        Memory leak introducido en Ãºltima versiÃ³n, causando
        agotamiento de connection pool y cascading failures.
        
        ğŸ¯ RECOMENDACIONES:
        1. Rollback inmediato a versiÃ³n anterior estable
        2. Reiniciar instancias afectadas
        3. Aumentar timeout de connections temporalmente
        4. Investigar cÃ³digo del Ãºltimo deploy
        5. Implementar circuit breaker si no existe
        
        ğŸ“ˆ IMPACTO ESTIMADO:
        - Severidad: HIGH
        - Servicios afectados: 3
        - Usuarios impactados: ~500-1000
        - Downtime estimado: 15-20 minutos
        
        â±ï¸  TIEMPO ESTIMADO DE RESOLUCIÃ“N:
        - Con rollback: 10-15 minutos
        - Fix en cÃ³digo: 2-4 horas
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ’­ El agente IA real proveerÃ­a:
        âœ“ AnÃ¡lisis mÃ¡s profundo del contexto histÃ³rico
        âœ“ CorrelaciÃ³n con incidentes similares pasados
        âœ“ Confianza del anÃ¡lisis (score)
        âœ“ Referencias a documentaciÃ³n relevante
        âœ“ Scripts de remediaciÃ³n automÃ¡tica
        âœ“ PredicciÃ³n de impacto futuro

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BENEFICIOS DE RCA CON IA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# âœ… AnÃ¡lisis en segundos vs horas manualmente
# âœ… CorrelaciÃ³n de mÃºltiples fuentes de datos
# âœ… IdentificaciÃ³n de patrones no obvios
# âœ… Recomendaciones contextualizadas
# âœ… Aprendizaje de incidentes pasados
# âœ… ReducciÃ³n de MTTR (Mean Time To Resolution)
# âœ… DocumentaciÃ³n automÃ¡tica del anÃ¡lisis
# âœ… Disponible 24/7 sin fatiga humana
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

